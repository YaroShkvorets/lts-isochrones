<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.css' rel='stylesheet' />
    <link href='https://www.mapbox.com/base/latest/base.css' rel='stylesheet' />
    <style>
        #app { position:absolute; top:0; right:0; bottom:0; left:0; }
        #map { position:absolute; top:0; right:0; bottom:0; left:0; }
        .mapboxgl-popup-content { color:#000 }
    </style>
</head>
<body>
  <div id='app' class='col12 contain fill-navy dark clip'>
    <div id='map'></div>
    <div class='pin-right pad2'>
      <a href='#settings' class='button'>Settings</a>
    </div>
    <div id='settings' class='col4 pad2 fill-darken3 pin-left offcanvas-left animate scroll-styled'>
      <a href='#' class='fill-darken2 pad1 icon close button fr'></a>
      <div class='clearfix'></div>
      <form>
        <div class='rounded-toggle inline'>
          <input type='radio' name='dir' id='lts1' value='lts1'>
          <label for='lts1' >LTS-1</label>
          <input type='radio' name='dir' id='lts2' value='lts2'>
          <label for='lts2' >LTS-2</label>
          <input type='radio' name='dir' id='lts3' value='lts3'>
          <label for='lts3' >LTS-3</label>
          <input type='radio' name='dir' id='lts4' value='lts4' checked='checked'>
          <label for='lts4' >LTS-4</label>
        </div><br><br>
        <fieldset>
          <label for='radius'>Radius</label>
          <input id='radius' type='number' value='6' class='stretch' />
        </fieldset>
        <fieldset>
          <label for='cellSize'>Cell size</label>
          <input id='cellSize' type='number' value='0.1' class='stretch' />
        </fieldset>
        <fieldset>
          <label for='concavity'>Concavity</label>
          <input id='concavity' type='number' value='2' class='stretch' />
        </fieldset>
        <fieldset>
          <label for='lengthThreshold'>Length threshold</label>
          <input id='lengthThreshold' type='number' value='0' class='stretch' />
        </fieldset>
        </fieldset>
        <fieldset class='checkbox-pill clearfix'>
          <input type='checkbox' id='deintersect' checked='checked' value='true'>
          <label for='deintersect' class='button icon check quiet'>deintersect</label>
        </fieldset>
        <fieldset class='intervals checkbox-pill clearfix'>
          <input type='checkbox' id='i5' checked='checked' value=5>
          <label for='i5' class='button icon check quiet'>5m</label>
          <input type='checkbox' id='i10' checked='checked' value=10>
          <label for='i10' class='button icon check quiet'>10m</label>
          <input type='checkbox' id='i15' checked='checked' value=15>
          <label for='i15' class='button icon check quiet'>15m</label>
        </fieldset>

        <div class='rounded-toggle inline'>
          <input type='radio' id='kilometers' name='units' value='kilometers' checked='checked'>
          <label for='kilometers'>kilometers</label>
          <input type='radio' id='miles' name='units' value='miles'>
          <label for='miles'>miles</label>
        </div>
      </form>
    </div>
  </div>

  <script>
    var args = location.search.replace(/^\?/,'').split('&').reduce(function(o, param) {
      var keyvalue=param.split('=');
      o[keyvalue[0]] = keyvalue[1];
      return o;
    }, {});

    //mapboxgl.accessToken = args.access_token || localStorage.accessToken;
    mapboxgl.accessToken = 'pk.eyJ1IjoienpwdGljaGthIiwiYSI6ImNqN2FubTQ5ejBpZDAyd285MmZsdHN3d3IifQ.dc6SvmJLcl7KGPQlBYFj-g';
    var mapEl = document.getElementById('map');


    var coordinates = document.getElementById('coordinates');
    var map = new mapboxgl.Map({
        container: mapEl,
        style: 'mapbox://styles/mapbox/light-v8',
        center: [-75.697927,45.417431],
        zoom: 13
    });

    var isDragging;
    var isCursorOverPoint;

    var canvas = map.getCanvasContainer();

    var geojson = {
        "type": "FeatureCollection",
        "features": [{
            "type": "Feature",
            "geometry": {
                "type": "Point",
                "coordinates": [-75.697927,45.417431]
            }
        }]
    };
    var gridSource = {
        "type": "FeatureCollection",
        "features": []
    };

    function mouseDown() {
        if (!isCursorOverPoint) return;

        isDragging = true;

        // Set a cursor indicator
        canvas.style.cursor = 'grab';

        // Mouse events
        map.on('mousemove', onMove);
        map.once('mouseup', onUp);
    }

    function onMove(e) {
        if (!isDragging) return;
        var coords = e.lngLat;

        // Set a UI indicator for dragging.
        canvas.style.cursor = 'grabbing';
        geojson.features[0].geometry.coordinates = [coords.lng, coords.lat];

        map.getSource('point').setData(geojson);
    }

    function onUp(e) {

        canvas.style.cursor = '';

        // Unbind mouse events
        map.off('mousemove', onMove);
    }



    var layers = [
      [15, '#00aaFF', 0.1],
      [10, '#00aaFF', 0.2],
      [5, '#00aaFF', 0.8],
      [5, '#FF0000', 0.8],
    ];

    map.on('style.load', function () {
      map.addSource('grid', {
          "type" : "geojson",
          "data": gridSource
      });

      map.addSource('point', {
          "type": "geojson",
          "data": geojson
      });


      layers.forEach(function (layer, i) {
        if(i==3){
          map.addLayer({
            'id': 'grid-3',
            "type": "circle",
            'source': 'grid',
            "paint": {
              "circle-radius": 10,
              "circle-color": "#ff0000"
            },
            'filter': [
              'all',
              ['==', '$type', 'Point']
            ]
          })
        }
        else{

          map.addLayer({
            'id': 'grid-' + i,
            'type': 'fill',
            'source': 'grid',
            'layout': {},
            'paint': {
              'fill-color': layer[1],
              'fill-opacity': layer[2]
            },
            'filter': [
              'all',
              ['==', '$type', 'Polygon'],
              ['<=', 'time', layer[0]]
            ]
          }, 'road-path');
        }
      });

      map.addLayer({
          "id": "point",
          "type": "circle",
          "source": "point",
          "paint": {
              "circle-radius": 10,
              "circle-color": "#3887be"
          }
      });

      map.on('mouseenter', 'point', function() {
          map.setPaintProperty('point', 'circle-color', '#3bb2d0');
          canvas.style.cursor = 'move';
          isCursorOverPoint = true;
          map.dragPan.disable();
      });

      map.on('mousedown', mouseDown);

      map.on('mouseleave', 'point', function(e) {
        map.setPaintProperty('point', 'circle-color', '#3887be');
        canvas.style.cursor = '';
        isCursorOverPoint = false;
        map.dragPan.enable();


      });

      map.on('mouseup', function(e) {
        if (!isDragging) return;
        isDragging = false;

        mapEl.classList.add('loading');
        var intervals = Array.from(
          document.querySelectorAll('.intervals input[type="checkbox"]:checked')
        ).map(function(el) { return el.value });

        var params = {
          lng: e.lngLat.lng,
          lat: e.lngLat.lat,
          radius: document.getElementById('radius').value,
          deintersect: document.getElementById('deintersect').checked,
          cellSize: document.getElementById('cellSize').value,
          concavity: document.getElementById('concavity').value,
          lengthThreshold: document.getElementById('lengthThreshold').value,
          units: document.querySelector('input[name="units"]:checked').value,
          dir: document.querySelector('input[name="dir"]:checked').value,
        };

        var url = new URL("http://localhost:4000");
        Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
        (intervals.length > 0 ? intervals : [5, 10, 15]).forEach(interval => url.searchParams.append('intervals', interval));

        console.groupCollapsed(e.lngLat.lng, e.lngLat.lat);
        console.time('request');
        fetch(url)
          .then(response => response.json())
          .then((data) => {
            console.log(data);
            console.timeEnd('request');
            console.groupEnd();
            map.getSource('grid').setData(data);
            mapEl.classList.remove('loading');
          })
          .catch((error) => {
            console.error(error);
            mapEl.classList.remove('loading');
          });
      });
/* uncomment to show popup
      var popup = new mapboxgl.Popup({
          closeButton: false,
          closeOnClick: false
      });

      map.on('mousemove', function(e) {
        var features = map.queryRenderedFeatures(e.point, {
          layers: ['grid-0', 'grid-1', 'grid-2']
        });

        if (!features.length) {
            popup.remove();
            return;
        }
        var feature = features[0];
        popup.setLngLat(e.lngLat)
            .setHTML(feature.properties.time + ' minutes')
            .addTo(map);
      });
*/
    });

  </script>

</body>
</html>
